<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulados P√≥sCom UFBA</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase (Vers√£o 9 COMPAT - Mais f√°cil para HTML) -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <!-- Estilos Customizados -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #f4f7f6;
        }
        /* Paleta de Cores UFBA (Inspirada) */
        :root {
            --color-primary: #0C2340; /* Azul escuro */
            --color-secondary: #007A33; /* Verde (para sucesso) */
            --color-danger: #D9232D; /* Vermelho (para erro) */
            --color-light-gray: #e9ecef;
        }
        .bg-primary { background-color: var(--color-primary); }
        .text-primary { color: var(--color-primary); }
        .bg-secondary { background-color: var(--color-secondary); }
        .text-secondary { color: var(--color-secondary); }
        .text-danger { color: var(--color-danger); }

        /* Esconde se√ß√µes por padr√£o */
        .page-section {
            display: none;
        }
        
        /* Anima√ß√£o de carregamento */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, .3);
            border-top-color: var(--color-primary);
            border-left-color: var(--color-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        /* Estilos para o formul√°rio de admin */
        .question-block {
            border: 1px solid #ccc;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 8px;
            background-color: #fafafa;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Navbar Principal -->
    <nav class="bg-primary shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0 flex items-center">
                    <span class="text-white text-xl font-bold">Simulados P√≥sCom UFBA</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Conte√∫do Principal -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">

        <!-- 1. TELA DE CARREGAMENTO GLOBAL -->
        <section id="loadingScreen" class="page-section flex-col items-center justify-center" style="display: flex; min-height: 70vh;">
            <div class="loader"></div>
            <p class="text-primary text-lg font-semibold mt-4">Carregando...</p>
        </section>

        <!-- 2. TELA INICIAL (SELE√á√ÉO) -->
        <section id="homeScreen" class="page-section bg-white p-8 rounded-lg shadow-xl max-w-lg mx-auto text-center">
            <h1 class="text-3xl font-bold text-primary mb-6">Plataforma de Simulados</h1>
            <p class="text-lg text-gray-700 mb-8">Por favor, selecione seu perfil para continuar:</p>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="goToAluno" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-lg hover:bg-blue-700 transition-colors">
                    üë®‚Äçüéì Sou Aluno
                </button>
                <button id="goToProfessor" class="w-full sm:w-auto bg-gray-700 text-white font-bold py-3 px-8 rounded-lg text-lg hover:bg-gray-800 transition-colors">
                    üë©‚Äçüè´ Sou Professor
                </button>
            </div>
        </section>
        
        <!-- 3. TELA ALUNO - NOME -->
        <section id="alunoNameEntryScreen" class="page-section bg-white p-8 rounded-lg shadow-xl max-w-lg mx-auto">
            <h2 class="text-2xl font-bold text-primary mb-6">Iniciar Simulado</h2>
            <p class="text-gray-700 mb-4">Seu nome ser√° usado para registrar sua nota no final.</p>
            <form id="nameEntryForm">
                <div class="mb-4">
                    <label for="studentName" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                    <input type="text" id="studentName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Clara Santos">
                </div>
                <p id="nameError" class="text-danger text-sm mb-4"></p>
                <button type="submit" class="w-full bg-secondary text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-opacity-90 transition-colors">
                    Come√ßar
                </button>
                <button type="button" class="go-home-btn w-full mt-4 bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition-colors">
                    Voltar
                </button>
            </form>
        </section>

        <!-- 4. TELA ALUNO - EXAME -->
        <section id="alunoExamScreen" class="page-section">
            <div id="examError" class="hidden text-center text-danger font-semibold p-8 bg-white rounded-lg shadow-xl">
                <p>Erro ao carregar o simulado. Tente novamente.</p>
                <button class="go-home-btn mt-4 bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition-colors">
                    Voltar
                </button>
            </div>

            <div id="examContent" class="flex flex-col lg:flex-row gap-6">
                <!-- Coluna do Texto -->
                <div class="lg:w-1/2">
                    <div class="bg-white p-6 rounded-lg shadow-lg sticky top-24">
                        <h2 id="examTextTitle" class="text-xl font-bold text-primary mb-4 border-b pb-2">CARREGANDO...</h2>
                        <div id="examTextContent" class="prose max-w-none h-96 overflow-y-auto pr-2">
                            Carregando texto...
                        </div>
                    </div>
                </div>
                
                <!-- Coluna da Quest√£o -->
                <div class="lg:w-1/2">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <span id="examProgress" class="text-lg font-semibold text-primary">Quest√£o 1 de 20</span>
                            <div class="text-xl font-bold text-danger" id="questionTimer">04:30</div>
                        </div>
                        
                        <div>
                            <p id="examQuestionText" class="text-lg text-gray-800 mb-4">Carregando pergunta...</p>
                            <div id="examOptionsContainer" class="space-y-3">
                                <!-- Op√ß√µes de r√°dio -->
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-end">
                            <button id="nextQuestionButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">
                                Pr√≥xima Quest√£o
                            </button>
                            <button id="finishTestButton" class="hidden bg-secondary hover:bg-opacity-90 text-white font-bold py-2 px-6 rounded-lg">
                                Finalizar Prova
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. TELA ALUNO - RESULTADO -->
        <section id="alunoResultsScreen" class="page-section max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-xl text-center">
            <h2 class="text-3xl font-bold text-primary mb-4">Simulado Finalizado!</h2>
            
            <div id="resultStatus" class="text-4xl font-bold mb-2"></div>
            <div id="resultScore" class="text-6xl font-extrabold mb-4"></div>
            <p id="resultSummary" class="text-lg text-gray-700 mb-6"></p>
            
            <button class="go-home-btn bg-primary text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-opacity-90 transition-colors">
                Voltar ao In√≠cio
            </button>
        </section>

        <!-- 6. PAINEL DO PROFESSOR -->
        <section id="professorDashboardScreen" class="page-section bg-white p-6 sm:p-8 rounded-lg shadow-xl">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-3xl font-bold text-primary">Painel do Professor</h2>
                <button class="go-home-btn bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                    Voltar
                </button>
            </div>

            <!-- Abas -->
            <div class="flex border-b mb-6">
                <button id="tabButtonTextos" class="tab-btn py-2 px-4 font-semibold border-b-2 border-blue-600 text-blue-600">
                    Banco de Textos
                </button>
                <button id="tabButtonResultados" class="tab-btn py-2 px-4 font-semibold text-gray-500">
                    Resultados dos Alunos
                </button>
            </div>

            <!-- Conte√∫do das Abas -->
            <div>
                <!-- Aba 1: Banco de Textos -->
                <div id="tabContentTextos" class="tab-content">
                    <button id="showAddFormBtn" class="mb-6 bg-secondary text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90 transition-colors">
                        Adicionar Novo Texto
                    </button>
                    
                    <!-- Formul√°rio (escondido por padr√£o) -->
                    <form id="addTextForm" class="hidden space-y-6 mb-8 border p-6 rounded-lg">
                        <h3 id="formTitle" class="text-2xl font-semibold text-primary">Adicionar Novo Texto</h3>
                        <input type="hidden" id="textId">
                        
                        <div>
                            <label for="textTitle" class="block text-sm font-medium text-gray-700">T√≠tulo</label>
                            <input type="text" id="textTitle" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div>
                            <label for="textContent" class="block text-sm font-medium text-gray-700">Conte√∫do do Texto</label>
                            <textarea id="textContent" rows="10" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required></textarea>
                        </div>

                        <!-- Gerador de Quest√µes -->
                        <div id="questionsContainer" class="space-y-4">
                            <!-- JS vai popular 5 blocos aqui -->
                        </div>
                        
                        <div class="flex justify-end gap-4">
                            <button type="button" id="cancelEditButton" class="bg-gray-500 text-white py-2 px-4 rounded-md font-semibold hover:bg-gray-600">
                                Cancelar
                            </button>
                            <button type="submit" id="saveTextButton" class="bg-secondary text-white py-2 px-4 rounded-md font-semibold hover:bg-opacity-90">
                                Salvar
                            </button>
                        </div>
                    </form>

                    <!-- Lista de Textos -->
                    <div id="textsListContainer" class="space-y-4">
                        <p>Carregando textos...</p>
                    </div>
                </div>
                
                <!-- Aba 2: Resultados -->
                <div id="tabContentResultados" class="tab-content" style="display: none;">
                    <button id="exportCsvButton" class="mb-6 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 disabled:opacity-50">
                        Exportar CSV
                    </button>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aluno</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nota</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acertos</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Resultado</th>
                                </tr>
                            </thead>
                            <tbody id="allResultsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- JS vai popular aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

    </div> <!-- Fim do container principal -->

    <!-- Scripts -->
    <script>
        // ---------------------------------------------------------------------
        // INICIALIZA√á√ÉO E CONFIGURA√á√ÉO DO FIREBASE
        // ---------------------------------------------------------------------
        
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // COLOQUE AQUI AS CREDENCIAIS DO SEU PROJETO FIREBASE
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_AUTH_DOMAIN.firebaseapp.com",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_STORAGE_BUCKET.appspot.com",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID",
            appId: "SEU_APP_ID"
        };
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

        // Inicializa o Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase inicializado com sucesso.");
        } catch (e) {
            console.error("Erro ao inicializar o Firebase:", e);
            document.getElementById('loadingScreen').innerHTML = '<p class="text-danger font-bold text-lg">Erro: Verifique as credenciais do Firebase no c√≥digo HTML.</p>';
        }

        // Cole√ß√µes do Firestore
        const textsCollectionRef = db.collection("texts");
        const resultsCollectionRef = db.collection("results");

        // ---------------------------------------------------------------------
        // GERENCIAMENTO DE ESTADO E ROTEAMENTO
        // ---------------------------------------------------------------------

        let currentStudentName = null;
        let allExamTexts = []; // Cache dos textos
        let currentTest = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let questionTimerInterval = null;

        // Fun√ß√£o principal de "roteamento"
        function showView(viewId) {
            document.querySelectorAll('.page-section').forEach(section => {
                section.style.display = 'none';
            });
            const activeSection = document.getElementById(viewId);
            if (activeSection) {
                activeSection.style.display = 'block';
                // Se for flex
                if (viewId === 'loadingScreen') {
                    activeSection.style.display = 'flex';
                }
            }
        }
        
        // Bot√µes de Navega√ß√£o
        document.getElementById('goToAluno').addEventListener('click', () => showView('alunoNameEntryScreen'));
        document.getElementById('goToProfessor').addEventListener('click', () => showView('professorDashboardScreen'));
        document.querySelectorAll('.go-home-btn').forEach(btn => {
            btn.addEventListener('click', () => showView('homeScreen'));
        });

        // ---------------------------------------------------------------------
        // L√ìGICA DO ALUNO
        // ---------------------------------------------------------------------

        // 1. Entrada de Nome
        document.getElementById('nameEntryForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const nameInput = document.getElementById('studentName');
            const nameError = document.getElementById('nameError');
            
            if (nameInput.value.trim().length < 3) {
                nameError.textContent = 'Por favor, insira seu nome completo.';
                return;
            }
            nameError.textContent = '';
            currentStudentName = nameInput.value.trim();
            startTest();
        });

        // 2. Iniciar o Simulado
        async function startTest() {
            showView('loadingScreen');
            
            // Tenta usar o cache primeiro
            if (allExamTexts.length < 4) {
                try {
                    const querySnapshot = await textsCollectionRef.get();
                    allExamTexts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (err) {
                    console.error("Erro ao buscar textos:", err);
                    showView('alunoExamScreen');
                    document.getElementById('examContent').style.display = 'none';
                    document.getElementById('examError').style.display = 'block';
                    return;
                }
            }
            
            if (allExamTexts.length < 4) {
                console.error("Textos insuficientes no DB");
                showView('alunoExamScreen');
                document.getElementById('examContent').style.display = 'none';
                document.getElementById('examError').style.display = 'block';
                document.getElementById('examError').querySelector('p').textContent = 'N√£o h√° textos suficientes no banco. Contate o professor.';
                return;
            }

            // Embaralhar e pegar 4 textos
            const shuffled = allExamTexts.sort(() => 0.5 - Math.random());
            const selectedTexts = shuffled.slice(0, 4);
            
            // Achatar as 20 quest√µes
            currentTest = [];
            selectedTexts.forEach((text, textIndex) => {
                (text.questions || []).forEach((q) => { // Garante que questions existe
                    currentTest.push({
                        ...q,
                        textId: text.id,
                        textContent: text.text_content,
                        textTitle: `TEXTO ${textIndex + 1}: ${text.title || ''}`
                    });
                });
            });

            // Verifica se temos 20 quest√µes
            if (currentTest.length !== 20) {
                 console.error(`Erro: Foram encontradas ${currentTest.length} quest√µes, mas 20 eram esperadas.`);
                 showView('alunoExamScreen');
                 document.getElementById('examContent').style.display = 'none';
                 document.getElementById('examError').style.display = 'block';
                 document.getElementById('examError').querySelector('p').textContent = 'Erro na formata√ß√£o dos textos no banco. Contate o professor.';
                 return;
            }

            currentQuestionIndex = 0;
            userAnswers = Array(20).fill(null);
            
            document.getElementById('examContent').style.display = 'flex';
            document.getElementById('examError').style.display = 'none';
            
            displayCurrentQuestion();
            showView('alunoExamScreen');
        }

        // 3. Exibir a Quest√£o Atual
        function displayCurrentQuestion() {
            if (questionTimerInterval) {
                clearInterval(questionTimerInterval);
            }
            
            const q = currentTest[currentQuestionIndex];
            
            // Atualiza o texto (s√≥ se for o primeiro de um novo bloco de 5)
            if (currentQuestionIndex % 5 === 0) {
                document.getElementById('examTextTitle').textContent = q.textTitle;
                document.getElementById('examTextContent').innerHTML = (q.textContent || '').replace(/\n/g, '<br /><br />');
            }
            
            document.getElementById('examProgress').textContent = `Quest√£o ${currentQuestionIndex + 1} de 20`;
            document.getElementById('examQuestionText').textContent = q.question;
            
            const optionsContainer = document.getElementById('examOptionsContainer');
            optionsContainer.innerHTML = '';
            (q.options || []).forEach((option, index) => {
                const letter = String.fromCharCode(65 + index); // A, B, C...
                optionsContainer.innerHTML += `
                    <label class="flex items-center p-3 rounded-md border border-gray-200 hover:bg-gray-100 cursor-pointer">
                        <input type="radio" name="option" value="${letter}" class="mr-3">
                        <span class="text-gray-800"><span class="font-semibold">(${letter})</span> ${option}</span>
                    </label>
                `;
            });

            document.getElementById('nextQuestionButton').classList.toggle('hidden', currentQuestionIndex === 19);
            document.getElementById('finishTestButton').classList.toggle('hidden', currentQuestionIndex !== 19);

            startQuestionTimer();
        }

        // 4. Timer da Quest√£o
        function startQuestionTimer() {
            let timeLeft = (4 * 60) + 30; // 270 segundos
            const timerEl = document.getElementById('questionTimer');

            function updateTimer() {
                const minutes = Math.floor(timeLeft / 60);
                let seconds = timeLeft % 60;
                seconds = seconds < 10 ? '0' + seconds : seconds;
                timerEl.textContent = `${minutes}:${seconds}`;

                if (timeLeft <= 0) {
                    clearInterval(questionTimerInterval);
                    timerEl.textContent = "00:00";
                    handleNextQuestion(true); // true = time ran out
                }
                timeLeft--;
            }
            
            updateTimer();
            questionTimerInterval = setInterval(updateTimer, 1000);
        }

        // 5. Bot√µes de Pr√≥xima/Finalizar
        document.getElementById('nextQuestionButton').addEventListener('click', () => handleNextQuestion(false));
        document.getElementById('finishTestButton').addEventListener('click', () => handleNextQuestion(false));

        function handleNextQuestion(timeRanOut) {
            clearInterval(questionTimerInterval);

            const selectedOption = document.querySelector('input[name="option"]:checked');
            let answer = null;
            if (timeRanOut) {
                answer = 'TIMEOUT';
            } else if (selectedOption) {
                answer = selectedOption.value;
            }
            userAnswers[currentQuestionIndex] = answer;
            
            if (currentQuestionIndex < 19) {
                currentQuestionIndex++;
                displayCurrentQuestion();
            } else {
                finishTest();
            }
        }

        // 6. Finalizar Teste
        async function finishTest() {
            showView('loadingScreen');
            let correctCount = 0;
            
            const details = currentTest.map((q, index) => {
                const isCorrect = (userAnswers[index] === q.correct_option);
                if (isCorrect) correctCount++;
                return {
                    question_text: q.question,
                    answered: userAnswers[index],
                    correct_option: q.correct_option,
                    is_correct: isCorrect
                };
            });

            const score = correctCount * 0.5;
            const passed = score >= 7.0;

            // Salvar no Firestore
            try {
                await resultsCollectionRef.add({
                    student_name: currentStudentName,
                    score: score,
                    correct: correctCount,
                    wrong: 20 - correctCount,
                    date: firebase.firestore.FieldValue.serverTimestamp(),
                    details: details
                });
            } catch (err) {
                console.error("Erro ao salvar resultado:", err);
            }

            // Exibir tela de resultados
            document.getElementById('resultScore').textContent = score.toFixed(1);
            document.getElementById('resultSummary').textContent = `Voc√™ acertou ${correctCount} de 20 quest√µes.`;
            
            const statusEl = document.getElementById('resultStatus');
            const scoreEl = document.getElementById('resultScore');
            
            if (passed) {
                statusEl.textContent = "‚úÖ Aprovado(a)!";
                statusEl.className = "text-4xl font-bold mb-2 text-secondary";
                scoreEl.className = "text-6xl font-extrabold mb-4 text-secondary";
            } else {
                statusEl.textContent = "‚ö†Ô∏è Reprovado(a)";
                statusEl.className = "text-4xl font-bold mb-2 text-danger";
                scoreEl.className = "text-6xl font-extrabold mb-4 text-danger";
            }
            
            showView('alunoResultsScreen');
        }

        // ---------------------------------------------------------------------
        // L√ìGICA DO PROFESSOR
        // ---------------------------------------------------------------------

        // Navega√ß√£o por Abas
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Estilos dos bot√µes
                tabButtons.forEach(btn => {
                    btn.classList.remove('border-blue-600', 'text-blue-600');
                    btn.classList.add('text-gray-500');
                });
                button.classList.add('border-blue-600', 'text-blue-600');
                button.classList.remove('text-gray-500');
                
                // Mostrar conte√∫do
                const targetId = button.id.replace('Button', 'Content');
                tabContents.forEach(content => {
                    content.style.display = (content.id === targetId) ? 'block' : 'none';
                });
                
                // Carregar dados da aba
                if (targetId === 'tabContentTextos') loadAdminTexts();
                if (targetId === 'tabContentResultados') loadAdminResults();
            });
        });

        // --- Aba 1: Gerenciar Textos ---
        const addTextForm = document.getElementById('addTextForm');
        const showAddFormBtn = document.getElementById('showAddFormBtn');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const textsListContainer = document.getElementById('textsListContainer');
        const textIdInput = document.getElementById('textId');
        
        // Gera os 5 blocos de quest√£o no formul√°rio
        function initQuestionBlocks() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                container.innerHTML += `
                    <div class="question-block">
                        <h4 class="font-semibold">Quest√£o ${i + 1}</h4>
                        <input type="text" id="q_text_${i}" placeholder="Texto da Pergunta" required class="mt-1 block w-full px-2 py-1 border border-gray-300 rounded-md">
                        <input type="text" id="q_opt_A_${i}" placeholder="Op√ß√£o A" required class="mt-1 block w-full px-2 py-1 border border-gray-300 rounded-md">
                        <input type="text" id="q_opt_B_${i}" placeholder="Op√ß√£o B" required class="mt-1 block w-full px-2 py-1 border border-gray-300 rounded-md">
                        <input type="text" id="q_opt_C_${i}" placeholder="Op√ß√£o C" required class="mt-1 block w-full px-2 py-1 border border-gray-300 rounded-md">
                        <input type="text" id="q_opt_D_${i}" placeholder="Op√ß√£o D" required class="mt-1 block w-full px-2 py-1 border border-gray-300 rounded-md">
                        <input type="text" id="q_opt_E_${i}" placeholder="Op√ß√£o E" required class="mt-1 block w-full px-2 py-1 border border-gray-300 rounded-md">
                        <select id="q_correct_${i}" required class="mt-2 block w-full px-2 py-1 border border-gray-300 rounded-md">
                            <option value="A">Resposta Correta: A</option>
                            <option value="B">Resposta Correta: B</option>
                            <option value="C">Resposta Correta: C</option>
                            <option value="D">Resposta Correta: D</option>
                            <option value="E">Resposta Correta: E</option>
                        </select>
                    </div>
                `;
            }
        }
        initQuestionBlocks(); // Chamar na inicializa√ß√£o
        
        // Resetar e esconder formul√°rio
        function resetTextForm() {
            addTextForm.reset();
            textIdInput.value = '';
            document.getElementById('formTitle').textContent = 'Adicionar Novo Texto';
            document.getElementById('saveTextButton').textContent = 'Salvar';
            addTextForm.style.display = 'none';
            showAddFormBtn.style.display = 'block';
        }

        showAddFormBtn.addEventListener('click', () => {
            resetTextForm(); // Garante que est√° limpo
            addTextForm.style.display = 'block';
            showAddFormBtn.style.display = 'none';
        });
        cancelEditButton.addEventListener('click', resetTextForm);

        // Salvar (Criar ou Atualizar) Texto
        addTextForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const textId = textIdInput.value;
            let questions = [];

            for (let i = 0; i < 5; i++) {
                questions.push({
                    question: document.getElementById(`q_text_${i}`).value,
                    options: [
                        document.getElementById(`q_opt_A_${i}`).value,
                        document.getElementById(`q_opt_B_${i}`).value,
                        document.getElementById(`q_opt_C_${i}`).value,
                        document.getElementById(`q_opt_D_${i}`).value,
                        document.getElementById(`q_opt_E_${i}`).value,
                    ],
                    correct_option: document.getElementById(`q_correct_${i}`).value
                });
            }
            
            const textData = {
                title: document.getElementById('textTitle').value,
                text_content: document.getElementById('textContent').value,
                questions: questions
            };
            
            document.getElementById('saveTextButton').textContent = 'Salvando...';
            document.getElementById('saveTextButton').disabled = true;

            try {
                if (textId) {
                    await textsCollectionRef.doc(textId).update(textData);
                } else {
                    await textsCollectionRef.add(textData);
                }
                resetTextForm();
                loadAdminTexts(); // Recarrega a lista
            } catch (err) {
                console.error("Erro ao salvar texto:", err);
                alert("Erro ao salvar. Verifique o console.");
            } finally {
                document.getElementById('saveTextButton').textContent = 'Salvar';
                document.getElementById('saveTextButton').disabled = false;
            }
        });

        // Carregar textos na lista do admin
        async function loadAdminTexts() {
            textsListContainer.innerHTML = '<p>Carregando textos...</p>';
            try {
                const querySnapshot = await textsCollectionRef.orderBy("title").get();
                allExamTexts = []; // Limpa o cache para for√ßar recarga
                
                if (querySnapshot.empty) {
                    textsListContainer.innerHTML = '<p>Nenhum texto cadastrado.</p>';
                    return;
                }
                
                textsListContainer.innerHTML = '';
                querySnapshot.forEach(doc => {
                    const text = { id: doc.id, ...doc.data() };
                    allExamTexts.push(text); // Atualiza o cache
                    
                    const snippet = (text.text_content || '').substring(0, 150) + '...';
                    textsListContainer.innerHTML += `
                        <div class="border rounded-lg p-4">
                            <p class="font-bold text-lg text-gray-800">${text.title || 'Sem T√≠tulo'}</p>
                            <p class="text-gray-700 italic">${snippet}</p>
                            <div class="mt-3 flex gap-2">
                                <button data-id="${text.id}" class="edit-btn bg-blue-600 text-white text-sm font-medium py-1 px-3 rounded-md hover:bg-blue-700">
                                    Editar
                                </button>
                                <button data-id="${text.id}" class="delete-btn bg-danger text-white text-sm font-medium py-1 px-3 rounded-md hover:bg-red-700">
                                    Excluir
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                // Adiciona event listeners aos novos bot√µes
                document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEditClick));
                document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDeleteClick));
                
            } catch (err) {
                console.error("Erro ao carregar textos:", err);
                textsListContainer.innerHTML = '<p class="text-danger">Erro ao carregar textos.</p>';
            }
        }
        
        // Fun√ß√µes de Editar e Excluir
        function handleEditClick(e) {
            const id = e.target.dataset.id;
            const text = allExamTexts.find(t => t.id === id);
            if (!text) return;
            
            resetTextForm();
            addTextForm.style.display = 'block';
            showAddFormBtn.style.display = 'none';
            
            document.getElementById('formTitle').textContent = 'Editar Texto';
            textIdInput.value = id;
            document.getElementById('textTitle').value = text.title || '';
            document.getElementById('textContent').value = text.text_content || '';
            
            (text.questions || []).forEach((q, i) => {
                document.getElementById(`q_text_${i}`).value = q.question;
                (q.options || []).forEach((opt, oIdx) => {
                     document.getElementById(`q_opt_${String.fromCharCode(65 + oIdx)}_${i}`).value = opt;
                });
                document.getElementById(`q_correct_${i}`).value = q.correct_option;
            });
            
            window.scrollTo(0, 0); // Rola para o topo
        }

        async function handleDeleteClick(e) {
            const id = e.target.dataset.id;
            if (confirm("Tem certeza que deseja excluir este texto? Esta a√ß√£o √© irrevers√≠vel.")) {
                try {
                    await textsCollectionRef.doc(id).delete();
                    loadAdminTexts(); // Recarrega
                } catch (err) {
                    console.error("Erro ao excluir texto:", err);
                }
            }
        }
        
        // --- Aba 2: Ver Resultados (Admin) ---
        let allResultsData = []; // Cache para CSV

        async function loadAdminResults() {
            const tableBody = document.getElementById('allResultsTableBody');
            tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center">Carregando...</td></tr>';
            allResultsData = [];
            
            try {
                const querySnapshot = await resultsCollectionRef.orderBy("date", "desc").get();
                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center">Nenhum resultado.</td></tr>';
                    return;
                }
                
                tableBody.innerHTML = '';
                querySnapshot.forEach(doc => {
                    const result = doc.data();
                    allResultsData.push(result); // Salva para o cache
                    
                    const date = result.date ? result.date.toDate().toLocaleString('pt-BR') : 'N/A';
                    const passed = result.score >= 7.0;
                    
                    tableBody.innerHTML += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${result.student_name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${passed ? 'text-secondary' : 'text-danger'}">${result.score.toFixed(1)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${result.correct} / 20</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${passed ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${passed ? 'Aprovado' : 'Reprovado'}
                                </span>
                            </td>
                        </tr>
                    `;
                });
                
                document.getElementById('exportCsvButton').disabled = false;

            } catch (err) {
                console.error("Erro ao carregar resultados:", err);
                tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-danger">Erro ao carregar.</td></tr>';
            }
        }
        
        // Exportar CSV
        document.getElementById('exportCsvButton').addEventListener('click', () => {
            if (allResultsData.length === 0) return;

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Nome do Aluno,Data,Nota,Acertos\n"; // Cabe√ßalho

            allResultsData.forEach(result => {
                const date = result.date ? result.date.toDate().toLocaleString('pt-BR') : 'N/A';
                const row = [
                    `"${result.student_name}"`,
                    `"${date}"`,
                    result.score.toFixed(1),
                    result.correct
                ].join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "resultados_simulados.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // ---------------------------------------------------------------------
        // INICIALIZA√á√ÉO DA APLICA√á√ÉO
        // ---------------------------------------------------------------------
        
        // Carrega os dados de textos (para o professor) e resultados (para o professor)
        // A aba do aluno carrega os textos "on-demand" quando ele clica em "Come√ßar"
        function initApp() {
            if (db) {
                loadAdminTexts();
                loadAdminResults();
                showView('homeScreen'); // Come√ßa na tela inicial
            }
        }
        
        // Adiciona um pequeno delay para garantir que o Firebase inicialize
        setTimeout(initApp, 500);

    </script>
</body>
</html>
